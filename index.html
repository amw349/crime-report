<html>
<head>
    <title>Crime in New York City</title>
    <link href="https://fonts.googleapis.com/css?family=Alegreya|Alegreya+Sans" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/default.min.css">
    <script type="text/javascript" src="js/geojson.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="http://d3js.org/topojson.v2.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>

    <style>
        body { font-family: 'Didot', Calibri, sans-serif; margin: 0;}
        svg {margin-bottom: 30px;}
        svg#border {background: url(images/banner.jpg);
                    display: block;
                    width: 100%;
                    height: 120px; }
        #borough_map {background-color: #fcfaf4;  
                        display: block;
                        margin: 0 auto;}
        #borough_plot {display: block;
                        margin: 0 auto;
        path.borough_map {stroke: 4px}
        .axisB line{
            stroke: #1a3239;
        }
        .axisB path{
            stroke: #1a3239;
        }
        .axisB text{
            fill: #1a3239;
        }  

    </style>
</head>
<body>
     <svg id="border" viewBox="0 0 100 10" preserveAspectRatio="none">
        <text fill= "#ffb900" text-anchor="middle" x="55" y="7" font-family="Didot" font-size="4.5px">NYPD Complaint Data Analysis</text>
        <image x="10" y="1.7" width="7" height="7" xlink:href="images/badge.png">
    </svg>

    <svg id="title_map" height="20" width="100%">
        <text fill= "#1a3239" text-anchor="middle" x="400" y="15" font-family="Didot" font-size="20px" text-decoration="underline">NYPD Complaint Map Projection</text>
    </svg>

    <svg id ="borough_map" width="800" height="700"></svg>
    <svg id ="borough_plot" width="800" height="450"></svg>

    <script>

    var geo;
    var tsv;

    var svg1 = d3.select("#borough_map");
    var svg2 = d3.select("#borough_plot");

    var projection = d3.geoMercator();

    d3.tsv("data/smaller.tsv", function(error, data) {
        tsv = data;
    });

    //Geojson data taken from https://github.com/dwillis/nyc-maps
    d3.json("data/boroughs.geojson", function (error, data) {
        geo = data;
        showMap();
        plotPoints();
        accumTimes();
    });

    function colorBorough(obj) {
        var name = obj.properties.BoroName;
        if (name == "Staten Island") return "#9fff80";
        else if (name == "Queens") return "#0d3300";
        else if (name == "Manhattan") return "#40ff00";
        else if (name == "Brooklyn") return "#00B200";
        else if (name == "Bronx") return "#006600"; 
    }

    function showMap() {

        projection.fitExtent([[100,100], [600, 600]], geo);
        pathGenerator = d3.geoPath().projection(projection);
        var paths = svg1.selectAll("path.borough_map").data(geo.features);

        paths.enter()
        .append("path")
        .attr("class", "borough_map")
        .attr("stroke","black")
        .attr("stroke-width",1)
        .attr("opacity",1)
        .attr("fill",colorBorough)
        .merge(paths)
        .attr("d", function (borough_map) { return pathGenerator(borough_map); });
    }

    function plotPoints() {
        //scale domains and ranges calculated by searching through the geojson file.
        var scaleLati = d3.scaleLinear().domain([40.91553,40.496115]).range([100,600]);
        var scaleLongi = d3.scaleLinear().domain([-74.25559,-73.70000]).range([100,600]);

        //Keys
        svg1.append("rect").attr("height",70).attr("x",680).attr("y",20).attr("width",95).attr("rx",3).attr("ry",3).attr("fill", "#1a3239");
        svg1.append("text").html("Violation")
        .attr("transform", "translate(690, 40)").attr("font-size","15").attr("fill", "yellow");
        svg1.append("text").html("Misdeanor")
        .attr("transform", "translate(690, 60)").attr("font-size","15").attr("fill", "orange");
        svg1.append("text").html("Felony")
        .attr("transform", "translate(690, 80)").attr("font-size","15").attr("fill", "red");

        //Pins 
        svg1.append("rect").attr("height",25).attr("x",135).attr("y",220).attr("width",200).attr("rx",3).attr("ry",3).attr("fill", "#40ff00"); //Manhattan
        svg1.append("rect").attr("height",25).attr("x",370).attr("y",65).attr("width",200).attr("rx",3).attr("ry",3).attr("fill", "#006600"); //Bronx
        svg1.append("rect").attr("height",25).attr("x",300).attr("y",550).attr("width",200).attr("rx",3).attr("ry",3).attr("fill", "#00B200"); //Brooklyn
        svg1.append("rect").attr("height",25).attr("x",540).attr("y",220).attr("width",200).attr("rx",3).attr("ry",3).attr("fill", "#0d3300"); //Queens
        svg1.append("rect").attr("height",25).attr("x",50).attr("y",380).attr("width",200).attr("rx",3).attr("ry",3).attr("fill", "#9fff80"); //Staten Island

        //Data
        tsv.forEach( function(d) {
            if ((d.Latitude != undefined) && (d.Longitude != undefined)){
                var lati = parseFloat(d.Latitude);
                var longi = parseFloat(d.Longitude);
                svg1.append("circle")
                .attr("cx", scaleLongi(longi))
                .attr("cy", scaleLati(lati))
                .attr("r", 2)
                .style("fill", function() { 
                    if (d.LAW_CAT_CD == "VIOLATION") {return "#ffff00";}
                    else if (d.LAW_CAT_CD == "MISDEMEANOR") {return "#FFA500";}
                    else if (d.LAW_CAT_CD == "FELONY") {return "#ff0000";}
                });
            }
        });
    }

    function accumTimes() {

        //Axis
        var scaleB = d3.scaleLinear().domain([0,24]).range([0,600]);
        var axB = d3.axisBottom(scaleB).tickFormat(function(d) {
            var ampm; var hour;
            if (d==24 || d-12<0) ampm = "AM"; else ampm = "PM";
            if (d%12 == 0) hour = 12; else hour = d%12;
            return hour+ampm;
        });
        svg2.append("g").attr("transform", "translate(150, 400)").attr("class", "axisB").call(axB);

        //Text
        svg2.append("text").html("Bronx").attr("transform", "translate(125, 355)").attr("text-anchor","end").attr("fill", "#1a3239");
        svg2.append("text").html("Brooklyn").attr("transform", "translate(125, 295)").attr("text-anchor","end").attr("fill", "#1a3239");
        svg2.append("text").html("Manhattan").attr("transform", "translate(125, 235)").attr("text-anchor","end").attr("fill", "#1a3239");
        svg2.append("text").html("Queens").attr("transform", "translate(125, 175)").attr("text-anchor","end").attr("fill", "#1a3239");
        svg2.append("text").html("Staten Island").attr("transform", "translate(125, 115)").attr("text-anchor","end").attr("fill", "#1a3239");
        svg2.append("text").html("Concentration of Reports by Time of Day (per Borough)")
        .attr("transform", "translate(400, 50)").attr("text-anchor","middle").attr("font-size","20").attr("fill", "#1a3239").attr("text-decoration", "underline");

        //Data
        tsv.forEach( function(d) {
            var dtime = d.CMPLNT_FR_TM
            if (dtime != undefined){
                var hour = dtime.split(":")[0];
                var minute = dtime.split(":")[1];
                var inthour = parseFloat(hour);
                var intminute = parseFloat(minute);

                svg2.append("rect")
                .attr("x", inthour*25+intminute*25/60+150)
                .attr("y", function () {
                    var name = d.BORO_NM;
                    if (name == "STATEN ISLAND") return 100;
                    else if (name == "QUEENS") return 160;
                    else if (name == "MANHATTAN") return 220;
                    else if (name == "BROOKLYN") return 280;
                    else return 340; //Bronx
                })
                .attr("height",20)
                .attr("width",6)
                .attr("opacity",0.1)
                .attr("fill", "#f7020d")
            }
        });
    }
    </script>

</body>
</html>
